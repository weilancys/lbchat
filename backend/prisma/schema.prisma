// Prisma Schema for LBChat
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// User Management
// ===========================================

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  username     String   @unique
  passwordHash String   @map("password_hash")
  displayName  String?  @map("display_name")
  avatarUrl    String?  @map("avatar_url")
  status       String?  @default("Hey, I'm using LBChat!")
  isOnline     Boolean  @default(false) @map("is_online")
  lastSeen     DateTime @default(now()) @map("last_seen")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  messages              Message[]
  conversationMembers   ConversationMember[]
  createdConversations  Conversation[]       @relation("CreatedBy")
  uploadedFiles         File[]
  refreshTokens         RefreshToken[]
  pushSubscriptions     PushSubscription[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

// ===========================================
// Conversations
// ===========================================

model Conversation {
  id        String           @id @default(uuid())
  type      ConversationType @default(DIRECT)
  name      String?
  avatarUrl String?          @map("avatar_url")
  createdBy String?          @map("created_by")
  createdAt DateTime         @default(now()) @map("created_at")
  updatedAt DateTime         @updatedAt @map("updated_at")

  // Relations
  creator  User?                @relation("CreatedBy", fields: [createdBy], references: [id])
  members  ConversationMember[]
  messages Message[]

  @@map("conversations")
}

enum ConversationType {
  DIRECT
  GROUP
}

model ConversationMember {
  id             String         @id @default(uuid())
  conversationId String         @map("conversation_id")
  userId         String         @map("user_id")
  role           MemberRole     @default(MEMBER)
  joinedAt       DateTime       @default(now()) @map("joined_at")
  lastReadAt     DateTime?      @map("last_read_at")

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@map("conversation_members")
}

enum MemberRole {
  ADMIN
  MEMBER
}

// ===========================================
// Messages
// ===========================================

model Message {
  id             String      @id @default(uuid())
  conversationId String      @map("conversation_id")
  senderId       String      @map("sender_id")
  content        String?
  type           MessageType @default(TEXT)
  fileId         String?     @map("file_id")
  metadata       Json?
  isEdited       Boolean     @default(false) @map("is_edited")
  isDeleted      Boolean     @default(false) @map("is_deleted")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderId], references: [id], onDelete: Cascade)
  file         File?        @relation(fields: [fileId], references: [id])

  @@index([conversationId, createdAt])
  @@map("messages")
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  SYSTEM
}

// ===========================================
// Files
// ===========================================

model File {
  id          String   @id @default(uuid())
  uploaderId  String   @map("uploader_id")
  filename    String
  originalName String  @map("original_name")
  mimeType    String   @map("mime_type")
  size        BigInt
  storagePath String   @map("storage_path")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  uploader User      @relation(fields: [uploaderId], references: [id], onDelete: Cascade)
  messages Message[]

  @@map("files")
}

// ===========================================
// Push Notifications
// ===========================================

model PushSubscription {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("push_subscriptions")
}
